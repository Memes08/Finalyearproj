{% extends 'base.html' %}

{% block title %}Analytics: {{ graph.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('visualization', graph_id=graph.id) }}">{{ graph.name }}</a></li>
                    <li class="breadcrumb-item active">Analytics</li>
                </ol>
            </nav>
            <h1 class="mb-0 display-4">Graph Analytics Dashboard</h1>
            <p class="lead text-muted">{{ graph.name }} - {{ graph.domain|title }} Domain</p>
        </div>
    </div>
    
    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-dark text-white shadow-sm h-100">
                <div class="card-body">
                    <h2 class="fw-bold text-info">{{ graph_data.node_count }}</h2>
                    <p class="mb-0">Total Nodes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white shadow-sm h-100">
                <div class="card-body">
                    <h2 class="fw-bold text-info">{{ graph_data.relationship_count }}</h2>
                    <p class="mb-0">Total Relationships</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white shadow-sm h-100">
                <div class="card-body">
                    <h2 class="fw-bold text-info">{{ "%.2f"|format(graph_data.density) }}%</h2>
                    <p class="mb-0">Graph Density</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white shadow-sm h-100">
                <div class="card-body">
                    <h2 class="fw-bold text-info">{{ graph_data.communities|length }}</h2>
                    <p class="mb-0">Communities</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Central Nodes -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm bg-dark text-white">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Key Nodes by Centrality</h5>
                    <span class="text-muted small">Top nodes by connection count</span>
                </div>
                <div class="card-body">
                    <div id="centrality-chart" class="chart-container" style="height:250px;"></div>
                </div>
                <div class="card-footer bg-dark">
                    <h6 class="mb-2">Top Influencers</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-dark">
                            <thead>
                                <tr>
                                    <th>Node</th>
                                    <th>Category</th>
                                    <th>Connections</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for node in graph_data.central_nodes[:5] %}
                                <tr>
                                    <td>{{ node.label }}</td>
                                    <td><span class="badge bg-info">{{ node.category }}</span></td>
                                    <td>{{ node.centrality }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Communities & Relationship Distribution -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm bg-dark text-white h-100">
                <div class="card-header">
                    <h5 class="mb-0">Community Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-dark">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category, count in graph_data.category_counts.items() %}
                                <tr>
                                    <td>{{ category }}</td>
                                    <td>{{ count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm bg-dark text-white h-100">
                <div class="card-header">
                    <h5 class="mb-0">Relationship Types</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-dark">
                            <thead>
                                <tr>
                                    <th>Relationship</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rel_type, count in graph_data.relationship_counts.items() %}
                                <tr>
                                    <td>{{ rel_type }}</td>
                                    <td>{{ count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Graph Health & Export -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm bg-dark text-white">
                <div class="card-header">
                    <h5 class="mb-0">Graph Actions</h5>
                </div>
                <div class="card-body d-flex justify-content-center">
                    <button class="btn btn-outline-info me-2" id="export-analytics">
                        <i class="fas fa-file-export me-1"></i> Export Analytics Report
                    </button>
                    <a href="{{ url_for('visualization', graph_id=graph.id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-project-diagram me-1"></i> Back to Visualization
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Export report functionality with error handling
        document.getElementById('export-analytics').addEventListener('click', function() {
            try {
                // Create analytics data object
                const analyticsData = {
                    graphInfo: {
                        name: "{{ graph.name }}",
                        description: "{{ graph.description|default('No description') }}",
                        domain: "{{ graph.domain }}",
                        created: "{{ graph.created_at.strftime('%Y-%m-%d') }}",
                        updated: "{{ graph.updated_at.strftime('%Y-%m-%d') }}"
                    },
                    metrics: {
                        nodeCount: {{ graph_data.node_count }},
                        relationshipCount: {{ graph_data.relationship_count }},
                        density: {{ "%.4f"|format(graph_data.density) }},
                        avgConnections: {{ "%.2f"|format(graph_data.avg_degree) }},
                        isolatedNodes: {{ graph_data.isolated_nodes }},
                        communityCount: {{ graph_data.communities|length }},
                        mostConnectedNodes: [
                            {% for node in graph_data.central_nodes[:5] %}
                                {
                                    id: "{{ node.id }}",
                                    label: "{{ node.label }}",
                                    category: "{{ node.category }}",
                                    centrality: {{ "%.2f"|format(node.centrality) }}
                                }{% if not loop.last %},{% endif %}
                            {% endfor %}
                        ],
                        categoryDistribution: {
                            {% for category, count in graph_data.category_counts.items() %}
                                "{{ category }}": {{ count }}{% if not loop.last %},{% endif %}
                            {% endfor %}
                        },
                        relationshipDistribution: {
                            {% for rel_type, count in graph_data.relationship_counts.items() %}
                                "{{ rel_type }}": {{ count }}{% if not loop.last %},{% endif %}
                            {% endfor %}
                        }
                    }
                };
                
                // Format timestamp for filename
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-').substring(0, 19);
                
                // Convert to JSON string with nice formatting
                const jsonData = JSON.stringify(analyticsData, null, 2);
                
                // Create a blob and download link
                const blob = new Blob([jsonData], { type: 'application/json' });
                
                // Try multiple download methods for compatibility
                try {
                    // Method 1: Using URL.createObjectURL
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `graph-analytics-${timestamp}.json`;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    
                    // Attempt to trigger download with a delay
                    setTimeout(() => {
                        try {
                            a.click();
                            // Clean up after a delay
                            setTimeout(() => {
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                            }, 200);
                        } catch (e) {
                            console.error("Click error:", e);
                            fallbackDownload(blob, `graph-analytics-${timestamp}.json`);
                        }
                    }, 50);
                } catch (error) {
                    console.error("Primary download method failed:", error);
                    fallbackDownload(blob, `graph-analytics-${timestamp}.json`);
                }
            } catch (error) {
                console.error("Export error:", error);
                alert("Export failed: " + error.message);
            }
        });
        
        // Fallback download function for browser compatibility
        function fallbackDownload(blob, fileName) {
            try {
                // Method 2: Using window.navigator.msSaveBlob (for IE/Edge)
                if (window.navigator && window.navigator.msSaveBlob) {
                    window.navigator.msSaveBlob(blob, fileName);
                    return;
                }
                
                // Method 3: Create data URL
                const reader = new FileReader();
                reader.onload = function() {
                    const dataUrl = reader.result;
                    const link = document.createElement("a");
                    link.href = dataUrl;
                    link.download = fileName;
                    link.style.display = "none";
                    document.body.appendChild(link);
                    link.click();
                    setTimeout(() => {
                        document.body.removeChild(link);
                    }, 100);
                };
                reader.readAsDataURL(blob);
            } catch (fallbackError) {
                console.error("Fallback download failed:", fallbackError);
                alert("Export failed - your browser may not support the download feature.");
            }
        }
    });
</script>
{% endblock %}