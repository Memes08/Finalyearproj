{% extends "base.html" %}

{% block title %}Visualization - Knowledge Graph Builder{% endblock %}

{% block additional_head %}
<style>
    .d3-tooltip {
        position: absolute;
        text-align: center;
        padding: 8px;
        font: 12px sans-serif;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border: 0px;
        border-radius: 4px;
        pointer-events: none;
        max-width: 200px;
    }
    
    .graph-legend {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #333;
        border-radius: 4px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Graph Info</h5>
                    <span class="badge bg-info">{{ graph.domain }}</span>
                </div>
                <div class="card-body">
                    <h4>{{ graph.name }}</h4>
                    <p class="text-muted">
                        {% if graph.description %}
                            {{ graph.description }}
                        {% else %}
                            No description provided.
                        {% endif %}
                    </p>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <strong>Created:</strong> {{ graph.created_at.strftime('%Y-%m-%d') }}<br>
                        <strong>Last Updated:</strong> {{ graph.updated_at.strftime('%Y-%m-%d') }}
                    </div>
                    
                    <div class="mb-3">
                        <h6>Input Sources</h6>
                        {% if input_sources %}
                            <ul class="list-group">
                                {% for source in input_sources %}
                                    <li class="list-group-item bg-dark d-flex justify-content-between align-items-center">
                                        <div>
                                            {% if source.source_type == 'video' %}
                                                <i class="fas fa-film me-2 text-info"></i>
                                            {% elif source.source_type == 'csv' %}
                                                <i class="fas fa-file-csv me-2 text-success"></i>
                                            {% elif source.source_type == 'url' %}
                                                <i class="fab fa-github me-2 text-warning"></i>
                                            {% endif %}
                                            
                                            {% if source.filename %}
                                                {{ source.filename }}
                                            {% elif source.url %}
                                                {{ source.url.split('/')[-1] }}
                                            {% else %}
                                                Unknown source
                                            {% endif %}
                                        </div>
                                        <div>
                                            <span class="badge bg-secondary" title="Entities">
                                                {{ source.entity_count }}E
                                            </span>
                                            <span class="badge bg-secondary" title="Relationships">
                                                {{ source.relationship_count }}R
                                            </span>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No input sources added yet.</p>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('process_data', graph_id=graph.id) }}" class="btn btn-outline-info">
                            <i class="fas fa-file-upload me-2"></i> Add More Data
                        </a>
                        <a href="{{ url_for('query_graph', graph_id=graph.id) }}" class="btn btn-outline-info">
                            <i class="fas fa-search me-2"></i> Query Graph
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-dark">
                    <h5 class="mb-0">Controls</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Zoom</label>
                        <div class="d-flex">
                            <button id="zoom-in" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button id="zoom-out" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button id="zoom-reset" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Layout</label>
                        <select id="layout-select" class="form-select">
                            <option value="force">Force-Directed</option>
                            <option value="radial">Radial</option>
                            <option value="grid">Grid</option>
                        </select>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="show-labels">
                        <label class="form-check-label" for="show-labels">Show All Labels</label>
                    </div>
                    
                    <hr>
                    
                    <div id="graph-info" class="small">
                        <p class="mb-1"><strong>Nodes:</strong> <span id="node-count">-</span></p>
                        <p class="mb-1"><strong>Relationships:</strong> <span id="relationship-count">-</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="card">
                <div class="card-header bg-dark">
                    <h5 class="mb-0">Knowledge Graph Visualization</h5>
                </div>
                <div class="card-body p-0">
                    <div id="graph-visualization" data-graph-id="{{ graph.id }}" class="w-100" style="height: 700px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script src="{{ url_for('static', filename='js/graph_viz.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const graphContainer = document.getElementById('graph-visualization');
        const graphId = graphContainer.getAttribute('data-graph-id');
        
        // Initialize visualization
        const graphViz = new KnowledgeGraphVisualizer('graph-visualization', {
            nodeRadius: 15,
            linkDistance: 150,
            chargeStrength: -400
        });
        
        // Load graph data
        graphViz.loadData(graphId);
        
        // Add control handlers
        document.getElementById('zoom-in').addEventListener('click', function() {
            const svgElement = document.querySelector('#graph-visualization svg');
            const currentZoom = d3.zoomTransform(svgElement);
            
            d3.select(svgElement)
                .transition()
                .duration(300)
                .call(d3.zoom().transform, 
                    d3.zoomIdentity.translate(currentZoom.x, currentZoom.y).scale(currentZoom.k * 1.3));
        });
        
        document.getElementById('zoom-out').addEventListener('click', function() {
            const svgElement = document.querySelector('#graph-visualization svg');
            const currentZoom = d3.zoomTransform(svgElement);
            
            d3.select(svgElement)
                .transition()
                .duration(300)
                .call(d3.zoom().transform, 
                    d3.zoomIdentity.translate(currentZoom.x, currentZoom.y).scale(currentZoom.k * 0.7));
        });
        
        document.getElementById('zoom-reset').addEventListener('click', function() {
            const svgElement = document.querySelector('#graph-visualization svg');
            
            d3.select(svgElement)
                .transition()
                .duration(300)
                .call(d3.zoom().transform, d3.zoomIdentity);
        });
        
        // Handle layout changes
        document.getElementById('layout-select').addEventListener('change', function() {
            // This would normally change the layout algorithm
            // For simplicity, we'll just restart the simulation
            graphViz.simulation.alpha(1).restart();
        });
        
        // Toggle node labels
        document.getElementById('show-labels').addEventListener('change', function() {
            const showLabels = this.checked;
            
            d3.selectAll('.node-label')
                .style('display', showLabels ? 'block' : null)
                .style('font-size', showLabels ? '12px' : '10px');
        });
        
        // Update graph info when data is loaded
        const observer = new MutationObserver(function(mutations) {
            for(let mutation of mutations) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    updateGraphInfo();
                }
            }
        });
        
        observer.observe(graphContainer, { childList: true, subtree: true });
        
        function updateGraphInfo() {
            // Count nodes and relationships in visualization
            const nodeCount = document.querySelectorAll('.node').length;
            const relationshipCount = document.querySelectorAll('.link').length;
            
            document.getElementById('node-count').textContent = nodeCount;
            document.getElementById('relationship-count').textContent = relationshipCount;
        }
        
        // Handle window resize
        window.addEventListener('resize', function() {
            graphViz.resize();
        });
    });
</script>
{% endblock %}
