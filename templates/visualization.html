{% extends "base.html" %}

{% block title %}Visualization - Knowledge Graph Builder{% endblock %}

{% block additional_head %}
<style>
    .d3-tooltip {
        position: absolute;
        text-align: center;
        padding: 10px;
        font: 12px sans-serif;
        background: rgba(0, 0, 0, 0.9);
        color: #fff;
        border: 0px;
        border-radius: 6px;
        pointer-events: none;
        max-width: 240px;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .graph-legend {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #333;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .legend-title {
        font-weight: bold;
        margin-bottom: 5px;
        color: #eee;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        padding: 3px;
        border-radius: 3px;
        transition: background-color 0.2s;
    }
    
    .legend-item:hover {
        background-color: rgba(255,255,255,0.1);
        cursor: pointer;
    }
    
    .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        margin-right: 8px;
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .node {
        cursor: pointer;
        transition: opacity 0.3s;
    }
    
    .link {
        transition: opacity 0.3s, stroke-width 0.3s;
    }
    
    .node-details {
        background-color: rgba(30, 30, 30, 0.7);
        border-radius: 6px;
        padding: 10px;
        margin-top: 10px;
        border-left: 3px solid #1f77b4;
    }
    
    .filter-section {
        position: sticky;
        top: 10px;
    }
    
    /* Custom scrollbar for the legend */
    .graph-legend::-webkit-scrollbar {
        width: 6px;
    }
    
    .graph-legend::-webkit-scrollbar-track {
        background: #222;
    }
    
    .graph-legend::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 3px;
    }
    
    .graph-legend::-webkit-scrollbar-thumb:hover {
        background: #777;
    }
    
    /* Color swatch styles */
    .color-swatch {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.2s, border-color 0.2s;
    }
    
    .color-swatch:hover {
        transform: scale(1.2);
    }
    
    .color-swatch.selected {
        border-color: white;
        transform: scale(1.2);
    }
    
    /* Color picker tooltip */
    .color-picker-tooltip {
        position: absolute;
        background: rgba(30,30,30,0.9);
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        z-index: 1000;
    }
    
    /* Contextual Info Panel Styles */
    .progress-ring {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .progress-text {
        position: absolute;
        font-size: 12px;
        font-weight: bold;
        color: #f8f9fa;
    }
    
    .progress-ring-circle-bg {
        fill: transparent;
        stroke: #2c3e50;
        stroke-width: 3;
    }
    
    .progress-ring-circle {
        fill: transparent;
        stroke: #0dcaf0;
        stroke-width: 3;
        stroke-linecap: round;
        transform-origin: center;
        transform: rotate(-90deg);
        transition: stroke-dashoffset 0.5s ease;
    }
    
    .relationship-visualization {
        position: relative;
    }
    
    .node-box {
        padding: 8px 12px;
        background-color: #2c3e50;
        border-radius: 4px;
        font-weight: bold;
        min-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        text-align: center;
    }
    
    .arrow-container {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        margin: 0 10px;
        min-width: 80px;
    }
    
    .arrow-line {
        height: 2px;
        background-color: #0dcaf0;
        width: 100%;
        position: relative;
        animation: flow 1.5s infinite linear;
        background: linear-gradient(to right, #2c3e50, #0dcaf0, #2c3e50);
        background-size: 200% 100%;
    }
    
    @keyframes flow {
        0% { background-position: 100% 0; }
        100% { background-position: -100% 0; }
    }
    
    .arrow-head {
        width: 0;
        height: 0;
        border-top: 6px solid transparent;
        border-bottom: 6px solid transparent;
        border-left: 10px solid #0dcaf0;
        position: absolute;
        right: -5px;
    }
    
    .relationship-label {
        position: absolute;
        top: -24px;
        font-size: 12px;
        background-color: rgba(13, 202, 240, 0.2);
        padding: 2px 8px;
        border-radius: 10px;
        white-space: nowrap;
    }
    
    .connection-scroll {
        max-height: 200px;
        overflow-y: auto;
    }
    
    .connection-scroll::-webkit-scrollbar {
        width: 6px;
    }
    
    .connection-scroll::-webkit-scrollbar-track {
        background: #2c3e50;
    }
    
    .connection-scroll::-webkit-scrollbar-thumb {
        background-color: #495057;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header with Analytics Link -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item active">{{ graph.name }}</li>
                        </ol>
                    </nav>
                    <h2 class="mb-0">Knowledge Graph Visualization</h2>
                </div>
                <a href="{{ url_for('graph_analytics', graph_id=graph.id) }}" class="btn btn-warning btn-lg">
                    <i class="fas fa-chart-line me-2"></i> Analytics Dashboard
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-3">
            <!-- Graph Info Card -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Graph Info</h5>
                    <span class="badge bg-info">{{ graph.domain }}</span>
                </div>
                <div class="card-body">
                    <h4>{{ graph.name }}</h4>
                    <p class="text-muted">
                        {% if graph.description %}
                            {{ graph.description }}
                        {% else %}
                            No description provided.
                        {% endif %}
                    </p>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <strong>Created:</strong> {{ graph.created_at.strftime('%Y-%m-%d') }}<br>
                        <strong>Last Updated:</strong> {{ graph.updated_at.strftime('%Y-%m-%d') }}
                    </div>
                    
                    <div class="mb-3">
                        <h6>Input Sources</h6>
                        {% if input_sources %}
                            <ul class="list-group">
                                {% for source in input_sources %}
                                    <li class="list-group-item bg-dark d-flex justify-content-between align-items-center">
                                        <div>
                                            {% if source.source_type == 'csv' %}
                                                <i class="fas fa-file-csv me-2 text-success"></i>
                                            {% elif source.source_type == 'url' %}
                                                <i class="fab fa-github me-2 text-warning"></i>
                                            {% else %}
                                                <i class="fas fa-file me-2 text-light"></i>
                                            {% endif %}
                                            
                                            {% if source.filename %}
                                                {{ source.filename }}
                                            {% elif source.url %}
                                                {{ source.url.split('/')[-1] }}
                                            {% else %}
                                                Unknown source
                                            {% endif %}
                                        </div>
                                        <div>
                                            <span class="badge bg-secondary" title="Entities">
                                                {{ source.entity_count }}E
                                            </span>
                                            <span class="badge bg-secondary" title="Relationships">
                                                {{ source.relationship_count }}R
                                            </span>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No input sources added yet.</p>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('process_data', graph_id=graph.id) }}" class="btn btn-outline-info">
                            <i class="fas fa-file-upload me-2"></i> Add More Data
                        </a>
                        <a href="{{ url_for('query_graph', graph_id=graph.id) }}" class="btn btn-outline-info">
                            <i class="fas fa-search me-2"></i> Query Graph
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Controls and Filters Card -->
            <div class="card mb-4 shadow-sm filter-section">
                <div class="card-header bg-dark">
                    <h5 class="mb-0">Graph Controls</h5>
                </div>
                <div class="card-body">
                    <!-- Search box -->
                    <div class="mb-3">
                        <label class="form-label">Search Nodes</label>
                        <div class="input-group">
                            <input type="text" id="node-search" class="form-control" placeholder="Search by name...">
                            <button class="btn btn-outline-secondary" type="button" id="search-button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <hr>
                    
                    <!-- Filter options -->
                    <div class="mb-3">
                        <label class="form-label">Filter by Category</label>
                        <select id="category-filter" class="form-select mb-2">
                            <option value="all">All Categories</option>
                        </select>
                        
                        <label class="form-label">Filter by Relationship</label>
                        <select id="relationship-filter" class="form-select">
                            <option value="all">All Relationships</option>
                        </select>
                    </div>
                    
                    <hr>
                    
                    <!-- Layout controls -->
                    <div class="mb-3">
                        <label class="form-label">Graph Layout</label>
                        <select id="layout-select" class="form-select">
                            <option value="force">Force-Directed</option>
                            <option value="radial">Radial</option>
                            <option value="grid">Grid</option>
                        </select>
                    </div>
                    
                    <!-- Graph Theme Switcher -->
                    <div class="p-3 mb-4 border border-info rounded bg-dark">
                        <h5 class="d-flex align-items-center text-info mb-3">
                            <i class="fas fa-palette me-2"></i>
                            Theme Customizer
                            <span class="badge bg-danger ms-2 pulse">New!</span>
                        </h5>
                        <label class="form-label fw-bold">Graph Appearance</label>
                        <select id="theme-select" class="form-select form-select-lg mb-3 border-info">
                            <option value="dark">Dark Theme</option>
                            <option value="light">Light Theme</option>
                            <option value="custom">Custom Theme</option>
                        </select>
                        
                        <!-- Custom color palette (initially hidden) -->
                        <div id="custom-palette-container" class="mt-3 d-none">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-bold mb-0">Custom Color Palette</label>
                                <span class="badge bg-info">Click to Select</span>
                            </div>
                            <div class="d-flex flex-wrap gap-2 mb-3 p-2 border border-secondary rounded">
                                <div class="color-swatch" data-color="#5E3E9C" style="background-color: #5E3E9C;"></div>
                                <div class="color-swatch" data-color="#4A90E2" style="background-color: #4A90E2;"></div>
                                <div class="color-swatch" data-color="#43B88E" style="background-color: #43B88E;"></div>
                                <div class="color-swatch" data-color="#E2725B" style="background-color: #E2725B;"></div>
                                <div class="color-swatch" data-color="#E2CC5B" style="background-color: #E2CC5B;"></div>
                                <div class="color-swatch" data-color="#B05B85" style="background-color: #B05B85;"></div>
                            </div>
                            <button id="save-theme" class="btn btn-info w-100">
                                <i class="fas fa-save me-2"></i>Save Custom Theme
                            </button>
                        </div>
                    </div>
                    
                    <style>
                    .pulse {
                        animation: pulse-animation 2s infinite;
                    }
                    
                    @keyframes pulse-animation {
                        0% { transform: scale(1); }
                        50% { transform: scale(1.2); }
                        100% { transform: scale(1); }
                    }
                    </style>
                    
                    <!-- Zoom controls -->
                    <div class="mb-3">
                        <label class="form-label">Zoom Controls</label>
                        <div class="d-flex">
                            <button id="zoom-in" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button id="zoom-out" class="btn btn-sm btn-outline-secondary me-2">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button id="zoom-reset" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Display options -->
                    <div class="mb-3">
                        <label class="form-label">Display Options</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="show-labels">
                            <label class="form-check-label" for="show-labels">Show All Labels</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="show-relationship-labels">
                            <label class="form-check-label" for="show-relationship-labels">Show Relationship Labels</label>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Reset button -->
                    <div class="mb-3">
                        <button id="reset-filters" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-undo me-2"></i> Reset All Filters
                        </button>
                    </div>
                    
                    <!-- Graph statistics -->
                    <div id="graph-info" class="p-2 border border-secondary rounded bg-dark">
                        <small>
                            <div><strong>Total Nodes:</strong> <span id="total-node-count">-</span></div>
                            <div><strong>Total Relationships:</strong> <span id="total-relationship-count">-</span></div>
                            <div><strong>Visible Nodes:</strong> <span id="visible-node-count">-</span></div>
                            <div><strong>Visible Relationships:</strong> <span id="visible-relationship-count">-</span></div>
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Node Detail Card (initially hidden) -->
            <!-- Contextual Info Panels -->
            <div class="mb-4">
                <!-- Tabs for Node and Relationship Details -->
                <ul class="nav nav-tabs nav-fill" id="contextInfoTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="node-tab" data-bs-toggle="tab" data-bs-target="#node-panel" type="button" role="tab" aria-controls="node-panel" aria-selected="true">
                            <i class="fas fa-dot-circle me-1"></i> Node Details
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="relationship-tab" data-bs-toggle="tab" data-bs-target="#relationship-panel" type="button" role="tab" aria-controls="relationship-panel" aria-selected="false">
                            <i class="fas fa-exchange-alt me-1"></i> Relationship Details
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="contextInfoTabContent">
                    <!-- Node Details Panel -->
                    <div class="tab-pane fade show active" id="node-panel" role="tabpanel" aria-labelledby="node-tab">
                        <div id="node-detail-card" class="card shadow-sm d-none">
                            <div class="card-header bg-dark d-flex justify-content-between">
                                <h5 class="mb-0">Node Details</h5>
                                <span class="badge bg-info" id="selected-node-id"></span>
                            </div>
                            <div class="card-body">
                                <!-- Node Identity -->
                                <div class="mb-3">
                                    <h6 id="selected-node-label" class="border-bottom pb-2 text-info">-</h6>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <div>
                                            <span class="badge bg-secondary me-2" id="selected-node-category">-</span>
                                            <small class="text-muted" id="selected-node-created-date"></small>
                                        </div>
                                        <div id="node-metrics-badge" class="badge bg-dark border border-info px-2 py-1">
                                            <small>Centrality: <span id="selected-node-centrality">-</span></small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Node Properties -->
                                <div class="mb-3">
                                    <h6 class="d-flex justify-content-between align-items-center">
                                        <span>Properties</span>
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#nodePropertiesCollapse">
                                            <i class="fas fa-list"></i>
                                        </button>
                                    </h6>
                                    <div class="collapse show" id="nodePropertiesCollapse">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-dark table-bordered mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Property</th>
                                                        <th>Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="node-properties-table">
                                                    <tr>
                                                        <td colspan="2" class="text-center text-muted">No properties available</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Node Connections -->
                                <div id="node-connections" class="mb-3">
                                    <h6 class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Connections</span>
                                        <span class="badge bg-secondary" id="total-connections-badge">0</span>
                                    </h6>
                                    
                                    <!-- Connection Tabs -->
                                    <ul class="nav nav-pills nav-fill small mb-3" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="incoming-tab" data-bs-toggle="pill" data-bs-target="#incoming-connections" type="button" role="tab">
                                                <i class="fas fa-arrow-down me-1"></i> Incoming <span class="badge bg-dark" id="incoming-count">0</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="outgoing-tab" data-bs-toggle="pill" data-bs-target="#outgoing-connections" type="button" role="tab">
                                                <i class="fas fa-arrow-up me-1"></i> Outgoing <span class="badge bg-dark" id="outgoing-count">0</span>
                                            </button>
                                        </li>
                                    </ul>
                                    
                                    <!-- Connection Content -->
                                    <div class="tab-content">
                                        <div class="tab-pane fade show active" id="incoming-connections" role="tabpanel">
                                            <div class="connection-scroll" style="max-height: 200px; overflow-y: auto;">
                                                <ul class="list-group list-group-flush" id="incoming-connections-list">
                                                    <li class="list-group-item bg-dark text-muted">Select a node to view connections</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="outgoing-connections" role="tabpanel">
                                            <div class="connection-scroll" style="max-height: 200px; overflow-y: auto;">
                                                <ul class="list-group list-group-flush" id="outgoing-connections-list">
                                                    <li class="list-group-item bg-dark text-muted">Select a node to view connections</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Node Insights -->
                                <div class="mb-3">
                                    <h6>Node Insights</h6>
                                    <div class="p-2 border border-secondary rounded bg-dark">
                                        <div id="node-insights">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <div class="progress-ring">
                                                        <svg width="40" height="40">
                                                            <circle class="progress-ring-circle-bg" cx="20" cy="20" r="15" />
                                                            <circle class="progress-ring-circle" id="node-importance-circle" cx="20" cy="20" r="15" 
                                                                stroke-dasharray="94.2" stroke-dashoffset="94.2" />
                                                        </svg>
                                                        <span class="progress-text" id="node-importance-value">-</span>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1">Node Importance</h6>
                                                    <p class="mb-0 small text-muted">Based on connectivity and centrality metrics</p>
                                                </div>
                                            </div>
                                            <div class="mt-2 small" id="node-importance-description">
                                                Select a node to view its importance in the graph.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="d-flex gap-2">
                                    <button id="focus-selected-node" class="btn btn-sm btn-outline-info flex-grow-1">
                                        <i class="fas fa-crosshairs me-1"></i> Focus
                                    </button>
                                    <button id="expand-selected-node" class="btn btn-sm btn-outline-secondary flex-grow-1">
                                        <i class="fas fa-project-diagram me-1"></i> Expand
                                    </button>
                                    <button id="export-node-data" class="btn btn-sm btn-outline-primary flex-grow-1">
                                        <i class="fas fa-file-export me-1"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Node Details Placeholder -->
                        <div id="node-details-placeholder" class="card shadow-sm bg-dark">
                            <div class="card-body text-center py-5">
                                <div class="mb-3">
                                    <i class="fas fa-dot-circle fa-3x text-muted"></i>
                                </div>
                                <h5 class="text-muted mb-3">Node Details</h5>
                                <p class="text-muted mb-0">Select a node in the graph to view detailed information</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Relationship Details Panel -->
                    <div class="tab-pane fade" id="relationship-panel" role="tabpanel" aria-labelledby="relationship-tab">
                        <div id="relationship-detail-card" class="card shadow-sm d-none">
                            <div class="card-header bg-dark d-flex justify-content-between">
                                <h5 class="mb-0">Relationship Details</h5>
                                <span class="badge bg-info" id="selected-relationship-id"></span>
                            </div>
                            <div class="card-body">
                                <!-- Relationship Type -->
                                <div class="mb-3">
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-warning py-2 px-3 me-2" id="selected-relationship-type">-</span>
                                        <span class="text-muted small" id="selected-relationship-created-date"></span>
                                    </div>
                                    <div class="relationship-visualization mt-3 p-3 border border-secondary rounded bg-dark text-center">
                                        <div class="d-flex align-items-center justify-content-center">
                                            <div class="node-box" id="relationship-source-node">
                                                Source
                                            </div>
                                            <div class="arrow-container mx-3">
                                                <div class="arrow-line"></div>
                                                <div class="arrow-head"></div>
                                                <span class="relationship-label" id="relationship-label-display">Relation</span>
                                            </div>
                                            <div class="node-box" id="relationship-target-node">
                                                Target
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Relationship Properties -->
                                <div class="mb-3">
                                    <h6 class="d-flex justify-content-between align-items-center">
                                        <span>Properties</span>
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#relationshipPropertiesCollapse">
                                            <i class="fas fa-list"></i>
                                        </button>
                                    </h6>
                                    <div class="collapse show" id="relationshipPropertiesCollapse">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-dark table-bordered mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Property</th>
                                                        <th>Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="relationship-properties-table">
                                                    <tr>
                                                        <td colspan="2" class="text-center text-muted">No properties available</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Relationship Semantics -->
                                <div class="mb-3">
                                    <h6>Relationship Semantics</h6>
                                    <div class="p-3 border border-secondary rounded bg-dark">
                                        <div id="relationship-semantics-content">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="me-2">
                                                    <i class="fas fa-info-circle text-info"></i>
                                                </div>
                                                <div>
                                                    <p class="mb-0 small" id="relationship-description">
                                                        Select a relationship to view its semantic description.
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="small mt-2 pt-2 border-top border-secondary">
                                                <p class="mb-0 text-muted" id="relationship-additional-info">
                                                    Additional information about this relationship will appear here.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Similar Relationships -->
                                <div class="mb-3">
                                    <h6 class="d-flex justify-content-between align-items-center">
                                        <span>Similar Relationships</span>
                                        <span class="badge bg-secondary" id="similar-relationships-count">0</span>
                                    </h6>
                                    <ul class="list-group list-group-flush small" id="similar-relationships-list">
                                        <li class="list-group-item bg-dark text-muted">
                                            Select a relationship to view similar patterns
                                        </li>
                                    </ul>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="d-flex gap-2">
                                    <button id="highlight-relationship" class="btn btn-sm btn-outline-info flex-grow-1">
                                        <i class="fas fa-highlighter me-1"></i> Highlight
                                    </button>
                                    <button id="find-similar-relationships" class="btn btn-sm btn-outline-secondary flex-grow-1">
                                        <i class="fas fa-search me-1"></i> Find Similar
                                    </button>
                                    <button id="export-relationship-data" class="btn btn-sm btn-outline-primary flex-grow-1">
                                        <i class="fas fa-file-export me-1"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Relationship Details Placeholder -->
                        <div id="relationship-details-placeholder" class="card shadow-sm bg-dark">
                            <div class="card-body text-center py-5">
                                <div class="mb-3">
                                    <i class="fas fa-exchange-alt fa-3x text-muted"></i>
                                </div>
                                <h5 class="text-muted mb-3">Relationship Details</h5>
                                <p class="text-muted mb-0">Select a relationship (edge) in the graph to view detailed information</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Visualization Area -->
        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Knowledge Graph Visualization</h5>
                    <div class="d-flex align-items-center">
                        <!-- Progressive Disclosure Controls -->
                        <div class="dropdown me-2">
                            <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="explorationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-glasses me-1"></i> Exploration
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="explorationDropdown">
                                <li><a class="dropdown-item" href="#" id="progressive-disclosure">
                                    <i class="fas fa-eye me-1"></i> Progressive Disclosure
                                </a></li>
                                <li><a class="dropdown-item" href="#" id="reset-disclosure">
                                    <i class="fas fa-undo me-1"></i> Reset Full View
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="expand-one-level">
                                    <i class="fas fa-project-diagram me-1"></i> Expand One Level
                                </a></li>
                                <li><a class="dropdown-item" href="#" id="focus-high-degree">
                                    <i class="fas fa-star me-1"></i> Focus on Key Nodes
                                </a></li>
                            </ul>
                        </div>
                        
                        <!-- Analytics Link -->
                        <a href="{{ url_for('graph_analytics', graph_id=graph.id) }}" class="btn btn-sm btn-outline-warning me-2">
                            <i class="fas fa-chart-line me-1"></i> Analytics
                        </a>
                        
                        <div class="dropdown me-2">
                            <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-download me-1"></i> Export
                            </button>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="exportDropdown">
                                <li><a class="dropdown-item" href="#" id="export-png">PNG Image</a></li>
                                <li><a class="dropdown-item" href="#" id="export-svg">SVG Vector</a></li>
                            </ul>
                        </div>
                        <div id="export-status-container" class="me-2 d-flex align-items-center">
                            <div id="export-spinner" class="spinner-border spinner-border-sm text-info me-2 d-none" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span id="export-status" class="small text-light"></span>
                        </div>
                        <span class="badge bg-secondary me-2" id="graph-filter-badge" style="display: none;">Filtered View</span>
                        <span class="badge bg-info" id="graph-node-badge">Ready</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="graph-visualization" data-graph-id="{{ graph.id }}" class="w-100" style="height: 700px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script src="{{ url_for('static', filename='js/graph_viz.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const graphContainer = document.getElementById('graph-visualization');
        const graphId = graphContainer.getAttribute('data-graph-id');
        let graphViz;
        
        // Initialize visualization
        graphViz = new KnowledgeGraphVisualizer('graph-visualization', {
            nodeRadius: 15,
            linkDistance: 150,
            chargeStrength: -400
        });
        
        // Load graph data
        graphViz.loadData(graphId);
        
        // Node search functionality
        document.getElementById('search-button').addEventListener('click', function() {
            const searchTerm = document.getElementById('node-search').value.trim();
            document.dispatchEvent(new CustomEvent('graphSearchEvent', {
                detail: { searchTerm: searchTerm }
            }));
            
            if (searchTerm) {
                document.getElementById('graph-filter-badge').style.display = 'inline-block';
                document.getElementById('graph-filter-badge').textContent = 'Search Results';
            } else {
                document.getElementById('graph-filter-badge').style.display = 'none';
            }
        });
        
        // Search on Enter key
        document.getElementById('node-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('search-button').click();
            }
        });
        
        // Reset filters
        document.getElementById('reset-filters').addEventListener('click', function() {
            document.getElementById('node-search').value = '';
            document.getElementById('category-filter').value = 'all';
            document.getElementById('relationship-filter').value = 'all';
            document.getElementById('graph-filter-badge').style.display = 'none';
            
            document.dispatchEvent(new CustomEvent('graphResetEvent'));
        });
        
        // Handle layout changes
        document.getElementById('layout-select').addEventListener('change', function() {
            const layoutType = this.value;
            document.dispatchEvent(new CustomEvent('graphLayoutEvent', {
                detail: { layout: layoutType }
            }));
        });
        
        // Category filter
        document.getElementById('category-filter').addEventListener('change', function() {
            const category = this.value;
            document.dispatchEvent(new CustomEvent('graphCategoryFilterEvent', {
                detail: { category: category }
            }));
            
            if (category !== 'all') {
                document.getElementById('graph-filter-badge').style.display = 'inline-block';
                document.getElementById('graph-filter-badge').textContent = `Category: ${category}`;
            } else {
                document.getElementById('graph-filter-badge').style.display = 'none';
            }
        });
        
        // Relationship filter
        document.getElementById('relationship-filter').addEventListener('change', function() {
            const relationship = this.value;
            document.dispatchEvent(new CustomEvent('graphRelationshipFilterEvent', {
                detail: { relationship: relationship }
            }));
            
            if (relationship !== 'all') {
                document.getElementById('graph-filter-badge').style.display = 'inline-block';
                document.getElementById('graph-filter-badge').textContent = `Relationship: ${relationship}`;
            } else {
                document.getElementById('graph-filter-badge').style.display = 'none';
            }
        });
        
        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', function() {
            const svgElement = document.querySelector('#graph-visualization svg');
            if (!svgElement) return;
            
            const currentZoom = d3.zoomTransform(svgElement);
            
            d3.select(svgElement)
                .transition()
                .duration(300)
                .call(d3.zoom().transform, 
                    d3.zoomIdentity.translate(currentZoom.x, currentZoom.y).scale(currentZoom.k * 1.3));
        });
        
        document.getElementById('zoom-out').addEventListener('click', function() {
            const svgElement = document.querySelector('#graph-visualization svg');
            if (!svgElement) return;
            
            const currentZoom = d3.zoomTransform(svgElement);
            
            d3.select(svgElement)
                .transition()
                .duration(300)
                .call(d3.zoom().transform, 
                    d3.zoomIdentity.translate(currentZoom.x, currentZoom.y).scale(currentZoom.k * 0.7));
        });
        
        document.getElementById('zoom-reset').addEventListener('click', function() {
            const svgElement = document.querySelector('#graph-visualization svg');
            if (!svgElement) return;
            
            d3.select(svgElement)
                .transition()
                .duration(300)
                .call(d3.zoom().transform, d3.zoomIdentity);
        });
        
        // Toggle node labels
        document.getElementById('show-labels').addEventListener('change', function() {
            const showLabels = this.checked;
            
            d3.selectAll('.node-label')
                .style('display', showLabels ? 'block' : null)
                .style('font-size', showLabels ? '12px' : '10px');
        });
        
        // Toggle relationship labels
        document.getElementById('show-relationship-labels').addEventListener('change', function() {
            const showLabels = this.checked;
            
            d3.selectAll('.link-label')
                .style('opacity', showLabels ? 1 : 0);
        });
        
        // Handle node selection
        document.addEventListener('nodeSelected', function(e) {
            const node = e.detail.node;
            const connections = e.detail.connections;
            
            // Update node detail card
            document.getElementById('node-detail-card').classList.remove('d-none');
            document.getElementById('selected-node-label').textContent = node.label;
            document.getElementById('selected-node-category').textContent = node.category;
            
            // Update incoming connections
            const incomingList = document.getElementById('incoming-connections-list');
            incomingList.innerHTML = '';
            
            if (connections.incoming.length === 0) {
                incomingList.innerHTML = '<li class="list-group-item bg-dark text-muted">No incoming connections</li>';
            } else {
                connections.incoming.forEach(conn => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item bg-dark';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>${conn.node.label}</span>
                            <span class="badge bg-secondary">${conn.relationship}</span>
                        </div>
                    `;
                    incomingList.appendChild(item);
                });
            }
            
            // Update outgoing connections
            const outgoingList = document.getElementById('outgoing-connections-list');
            outgoingList.innerHTML = '';
            
            if (connections.outgoing.length === 0) {
                outgoingList.innerHTML = '<li class="list-group-item bg-dark text-muted">No outgoing connections</li>';
            } else {
                connections.outgoing.forEach(conn => {
                    const item = document.createElement('li');
                    item.className = 'list-group-item bg-dark';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>${conn.node.label}</span>
                            <span class="badge bg-secondary">${conn.relationship}</span>
                        </div>
                    `;
                    outgoingList.appendChild(item);
                });
            }
            
            // Update node badge
            document.getElementById('graph-node-badge').textContent = 'Node Selected';
            document.getElementById('graph-filter-badge').style.display = 'inline-block';
            document.getElementById('graph-filter-badge').textContent = 'Filtered View';
            
            // Focus button
            document.getElementById('focus-selected-node').onclick = function() {
                graphViz.centerOnNode(node);
            };
        });
        
        // Handle node deselection
        document.addEventListener('nodeDeselected', function() {
            document.getElementById('node-detail-card').classList.add('d-none');
            document.getElementById('graph-node-badge').textContent = 'Ready';
            document.getElementById('graph-filter-badge').style.display = 'none';
        });
        
        // Update graph info when stats are updated
        document.addEventListener('graphStatsUpdated', function(e) {
            document.getElementById('total-node-count').textContent = e.detail.nodeCount;
            document.getElementById('total-relationship-count').textContent = e.detail.relationshipCount;
            document.getElementById('visible-node-count').textContent = e.detail.nodeCount;
            document.getElementById('visible-relationship-count').textContent = e.detail.relationshipCount;
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (graphViz) graphViz.resize();
        });
        
        // Export functionality
        document.getElementById('export-png').addEventListener('click', function(e) {
            e.preventDefault();
            if (graphViz) {
                graphViz.exportGraph('png');
            }
        });
        
        // Progressive Disclosure listeners
        document.getElementById('progressive-disclosure').addEventListener('click', function() {
            // Add active class to indicate it's enabled
            this.classList.toggle('active');
            const isActive = this.classList.contains('active');
            
            // Update text to show status
            this.innerHTML = isActive ? 
                '<i class="fas fa-eye me-1"></i> Progressive Disclosure (ON)' : 
                '<i class="fas fa-eye me-1"></i> Progressive Disclosure';
                
            if (graphViz) {
                // Initialize progressive disclosure mode
                graphViz.enableProgressiveDisclosure(isActive);
            }
            
            // Show status badge
            if (isActive) {
                document.getElementById('graph-filter-badge').style.display = 'inline-block';
                document.getElementById('graph-filter-badge').textContent = 'Progressive View';
                document.getElementById('graph-filter-badge').className = 'badge bg-primary me-2';
            } else {
                document.getElementById('graph-filter-badge').style.display = 'none';
                document.getElementById('graph-filter-badge').className = 'badge bg-secondary me-2';
            }
        });
        
        // Reset disclosure view
        document.getElementById('reset-disclosure').addEventListener('click', function() {
            // Reset the progressive disclosure button if it's active
            const progressiveButton = document.getElementById('progressive-disclosure');
            if (progressiveButton.classList.contains('active')) {
                progressiveButton.classList.remove('active');
                progressiveButton.innerHTML = '<i class="fas fa-eye me-1"></i> Progressive Disclosure';
            }
            
            // Reset badge
            document.getElementById('graph-filter-badge').style.display = 'none';
            
            if (graphViz) {
                // Reset to full view
                graphViz.resetDisclosure();
            }
        });
        
        // Expand one level of nodes around visible nodes
        document.getElementById('expand-one-level').addEventListener('click', function() {
            if (graphViz) {
                graphViz.expandOneLevel();
            }
        });
        
        // Focus on high-degree (key) nodes
        document.getElementById('focus-high-degree').addEventListener('click', function() {
            if (graphViz) {
                graphViz.focusOnKeyNodes();
            }
            
            // Show status badge
            document.getElementById('graph-filter-badge').style.display = 'inline-block';
            document.getElementById('graph-filter-badge').textContent = 'Key Nodes Focus';
            document.getElementById('graph-filter-badge').className = 'badge bg-warning text-dark me-2';
        });
        
        document.getElementById('export-svg').addEventListener('click', function(e) {
            e.preventDefault();
            if (graphViz) {
                graphViz.exportGraph('svg');
            }
        });
        
        // Theme switcher functionality
        document.getElementById('theme-select').addEventListener('change', function() {
            const selectedTheme = this.value;
            
            // Show/hide custom palette selector based on theme choice
            if (selectedTheme === 'custom') {
                document.getElementById('custom-palette-container').classList.remove('d-none');
            } else {
                document.getElementById('custom-palette-container').classList.add('d-none');
                
                // Apply the selected theme immediately
                if (graphViz) {
                    graphViz.applyTheme(selectedTheme);
                }
                
                // Store theme preference in localStorage
                localStorage.setItem('graphTheme', selectedTheme);
            }
        });
        
        // Color swatch selection
        const colorSwatches = document.querySelectorAll('.color-swatch');
        colorSwatches.forEach(swatch => {
            swatch.addEventListener('click', function() {
                // Toggle selection visual state
                colorSwatches.forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
                
                // Get the selected color
                const selectedColor = this.getAttribute('data-color');
                
                // Preview this color as primary in the custom theme
                const customPalette = Array.from(document.querySelectorAll('.color-swatch'))
                    .map(swatch => swatch.getAttribute('data-color'));
                
                // Apply the updated custom theme
                if (graphViz) {
                    graphViz.updateCustomPalette(customPalette);
                }
            });
        });
        
        // Save custom theme
        document.getElementById('save-theme').addEventListener('click', function() {
            // Store custom theme in localStorage
            const customColors = Array.from(document.querySelectorAll('.color-swatch'))
                .map(swatch => swatch.getAttribute('data-color'));
            
            localStorage.setItem('customGraphPalette', JSON.stringify(customColors));
            localStorage.setItem('graphTheme', 'custom');
            
            // Show saved confirmation
            const saveBtn = this;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = "Theme Saved!";
            saveBtn.classList.add('btn-success');
            saveBtn.classList.remove('btn-outline-info');
            
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.classList.remove('btn-success');
                saveBtn.classList.add('btn-outline-info');
            }, 2000);
        });
        
        // Load saved theme preference if any
        const savedTheme = localStorage.getItem('graphTheme') || 'dark';
        document.getElementById('theme-select').value = savedTheme;
        
        // Load custom palette if saved
        if (savedTheme === 'custom') {
            document.getElementById('custom-palette-container').classList.remove('d-none');
            
            const savedPalette = localStorage.getItem('customGraphPalette');
            if (savedPalette) {
                try {
                    const colors = JSON.parse(savedPalette);
                    // Apply saved custom colors to the swatches
                    const swatches = document.querySelectorAll('.color-swatch');
                    colors.forEach((color, index) => {
                        if (swatches[index]) {
                            swatches[index].style.backgroundColor = color;
                            swatches[index].setAttribute('data-color', color);
                        }
                    });
                    
                    // Apply the custom theme when graph is ready
                    setTimeout(() => {
                        if (graphViz) {
                            graphViz.updateCustomPalette(colors);
                        }
                    }, 1000);
                } catch (e) {
                    console.error('Error loading custom palette:', e);
                }
            }
        }
        
        // Initialize with the saved theme after a short delay
        setTimeout(() => {
            if (graphViz) {
                graphViz.applyTheme(savedTheme);
            }
        }, 1000);
        
        // Observer for visible node/relationship counts
        const observer = new MutationObserver(function() {
            document.getElementById('visible-node-count').textContent = 
                document.querySelectorAll('.node').length;
            document.getElementById('visible-relationship-count').textContent = 
                document.querySelectorAll('.link').length;
        });
        
        observer.observe(graphContainer, { childList: true, subtree: true });
    });
</script>
{% endblock %}
