{% extends 'base.html' %}

{% block title %}Analytics: {{ graph.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('visualization', graph_id=graph.id) }}">{{ graph.name }}</a></li>
                    <li class="breadcrumb-item active">Analytics</li>
                </ol>
            </nav>
            <h1 class="mb-0 display-4">Graph Analytics Dashboard</h1>
            <p class="lead text-muted">{{ graph.name }} - {{ graph.domain|title }} Domain</p>
        </div>
    </div>
    
    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-dark text-white shadow-sm h-100">
                <div class="card-body">
                    <h2 class="fw-bold text-info">{{ analytics.total_nodes }}</h2>
                    <p class="mb-0">Total Nodes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white shadow-sm h-100">
                <div class="card-body">
                    <h2 class="fw-bold text-info">{{ analytics.total_relationships }}</h2>
                    <p class="mb-0">Total Relationships</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white shadow-sm h-100">
                <div class="card-body">
                    <h2 class="fw-bold text-info">{{ analytics.density }}%</h2>
                    <p class="mb-0">Graph Density</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white shadow-sm h-100">
                <div class="card-body">
                    <h2 class="fw-bold text-info">{{ analytics.communities|length }}</h2>
                    <p class="mb-0">Communities</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Central Nodes -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm bg-dark text-white">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Key Nodes by Centrality</h5>
                    <span class="text-muted small">Top 10 nodes by connection count</span>
                </div>
                <div class="card-body">
                    <div id="centrality-chart" class="chart-container" style="height:250px;"></div>
                </div>
                <div class="card-footer bg-dark">
                    <h6 class="mb-2">Top Influencers</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-dark">
                            <thead>
                                <tr>
                                    <th>Node</th>
                                    <th>Category</th>
                                    <th>Incoming</th>
                                    <th>Outgoing</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for node in analytics.centrality[:5] %}
                                <tr>
                                    <td>{{ node.label }}</td>
                                    <td><span class="badge bg-info">{{ node.category }}</span></td>
                                    <td>{{ node.in_degree }}</td>
                                    <td>{{ node.out_degree }}</td>
                                    <td>{{ node.total_degree }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Communities & Predictive Analysis -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm bg-dark text-white h-100">
                <div class="card-header">
                    <h5 class="mb-0">Community Distribution</h5>
                </div>
                <div class="card-body">
                    <div id="community-chart" class="chart-container" style="height:250px;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm bg-dark text-white h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Predictive Insights</h5>
                    <a href="#" class="btn btn-sm btn-outline-info" data-bs-toggle="tooltip" title="Analyze for missing connections">
                        <i class="fas fa-magic me-1"></i> Run Analysis
                    </a>
                </div>
                <div class="card-body">
                    <div id="predictions-container">
                        <div class="alert alert-info bg-dark">
                            <h5><i class="fas fa-lightbulb me-2"></i> Potential Missing Connections</h5>
                            <p class="mb-3">Based on graph patterns, these connections may be missing:</p>
                            <div id="prediction-results">
                                <div class="text-center py-3" id="prediction-loading">
                                    <div class="spinner-border text-info" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Analyzing graph patterns...</p>
                                </div>
                                <div id="prediction-items"></div>
                                <div id="no-predictions" class="text-center py-3 d-none">
                                    <i class="fas fa-info-circle fa-2x text-info mb-2"></i>
                                    <p>No reliable predictions found. Try adding more data to your knowledge graph.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Graph Structure Analysis -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow-sm bg-dark text-white">
                <div class="card-header">
                    <h5 class="mb-0">Graph Structure Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Structural Balance</h6>
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 65%">Balanced: 65%</div>
                            </div>
                            <h6>Connection Completeness</h6>
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped bg-info" role="progressbar" style="width: 78%">Complete: 78%</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Relationship Distribution</h6>
                            <canvas id="relationship-chart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('visualization', graph_id=graph.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Back to Visualization
                </a>
                <div>
                    <button class="btn btn-outline-info me-2" id="export-analytics">
                        <i class="fas fa-file-export me-1"></i> Export Report
                    </button>
                    <button class="btn btn-outline-primary" id="schedule-analysis">
                        <i class="fas fa-calendar me-1"></i> Schedule Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const centralityData = {{ analytics.centrality|tojson }};
        const communitiesData = {{ analytics.communities|tojson }};
        
        // Setup centrality chart
        const centralityChart = d3.select('#centrality-chart');
        renderCentralityChart(centralityChart, centralityData);
        
        // Setup community chart
        const communityCtx = document.getElementById('community-chart');
        renderCommunityPieChart(communityCtx, communitiesData);
        
        // Setup relationship chart
        const relationshipCtx = document.getElementById('relationship-chart');
        renderRelationshipChart(relationshipCtx);
        
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Export report functionality
        document.getElementById('export-analytics').addEventListener('click', function() {
            alert('Analytics report export feature will be implemented soon.');
        });
        
        // Schedule analysis functionality
        document.getElementById('schedule-analysis').addEventListener('click', function() {
            alert('Scheduled analysis feature will be implemented soon.');
        });
        
        // Run initial predictive analysis
        document.querySelector('[data-bs-toggle="tooltip"]').addEventListener('click', function(e) {
            e.preventDefault();
            runPredictiveAnalysis();
        });
    });

    // Render bar chart for node centrality
    function renderCentralityChart(container, data) {
        const margin = {top: 20, right: 30, bottom: 70, left: 40};
        const width = container.node().getBoundingClientRect().width - margin.left - margin.right;
        const height = 250 - margin.top - margin.bottom;
        
        const svg = container.append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
            
        // X axis
        const x = d3.scaleBand()
            .range([0, width])
            .domain(data.map(d => d.label))
            .padding(0.2);
            
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "10px")
            .style("fill", "#ccc");
            
        // Y axis
        const y = d3.scaleLinear()
            .domain([0, d3.max(data, d => d.total_degree)])
            .range([height, 0]);
            
        svg.append("g")
            .call(d3.axisLeft(y))
            .selectAll("text")
            .style("fill", "#ccc");
            
        // Bars
        svg.selectAll("bars")
            .data(data)
            .enter()
            .append("rect")
                .attr("x", d => x(d.label))
                .attr("y", d => y(d.total_degree))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.total_degree))
                .attr("fill", "#17a2b8")
                .attr("rx", 3)
                .attr("ry", 3)
                .style("opacity", 0.7)
                .style("stroke", "#0c5460")
                .style("stroke-width", 1)
                .on("mouseover", function(event, d) {
                    d3.select(this).style("opacity", 1);
                    
                    svg.append("text")
                        .attr("class", "value-label")
                        .attr("x", x(d.label) + x.bandwidth()/2)
                        .attr("y", y(d.total_degree) - 5)
                        .attr("text-anchor", "middle")
                        .style("fill", "white")
                        .text(d.total_degree);
                })
                .on("mouseout", function() {
                    d3.select(this).style("opacity", 0.7);
                    svg.selectAll(".value-label").remove();
                });
    }
    
    // Render pie chart for communities
    function renderCommunityPieChart(container, data) {
        const ctx = document.createElement('canvas');
        ctx.id = "community-pie";
        ctx.height = 250;
        container.appendChild(ctx);
        
        const colors = [
            '#17a2b8', '#6610f2', '#6f42c1', '#e83e8c', '#fd7e14', 
            '#28a745', '#20c997', '#dc3545', '#ffc107', '#6c757d'
        ];
        
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(d => d.name),
                datasets: [{
                    data: data.map(d => d.count),
                    backgroundColor: colors.slice(0, data.length),
                    borderColor: '#343a40',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#ccc',
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value * 100) / total) + '%';
                                return `${label}: ${value} (${percentage})`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Render relationship type distribution
    function renderRelationshipChart(container) {
        // Sample data - in a real implementation, this would come from the backend
        const relationshipTypes = {
            'DIRECTED': 32,
            'ACTED_IN': 89,
            'BELONGS_TO': 47,
            'PRODUCED': 25,
            'WROTE': 18,
            'HAS_GENRE': 64
        };
        
        new Chart(container, {
            type: 'bar',
            data: {
                labels: Object.keys(relationshipTypes),
                datasets: [{
                    label: 'Relationship Count',
                    data: Object.values(relationshipTypes),
                    backgroundColor: 'rgba(23, 162, 184, 0.5)',
                    borderColor: 'rgba(23, 162, 184, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        ticks: {
                            color: '#ccc'
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#ccc'
                        }
                    }
                }
            }
        });
    }
    
    // Simulate predictive analysis
    function runPredictiveAnalysis() {
        const button = document.querySelector('[data-bs-toggle="tooltip"]');
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Analyzing...';
        button.disabled = true;
        
        // Simulate loading
        setTimeout(() => {
            button.innerHTML = '<i class="fas fa-magic me-1"></i> Run Analysis';
            button.disabled = false;
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success bg-dark border-success mt-3';
            alertDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i> Analysis complete! 3 potential connections identified.';
            
            const predictions = document.getElementById('predictions-container');
            predictions.prepend(alertDiv);
            
            // Automatically remove alert after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }, 2000);
    }
</script>
{% endblock %}