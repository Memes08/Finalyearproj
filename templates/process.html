{% extends "base.html" %}

{% block title %}Process Data - Knowledge Graph Builder{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Process Data</li>
                </ol>
            </nav>
            
            <div class="card mb-4">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Add Data to "{{ graph.name }}"</h4>
                    <span class="badge bg-info">{{ graph.domain }}</span>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('process_data', graph_id=graph.id) }}" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        
                        <!-- Input Selection Tabs -->
                        <ul class="nav nav-tabs mb-4" id="inputTypeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="video-tab" data-bs-toggle="tab" data-bs-target="#video-content" 
                                        type="button" role="tab" aria-controls="video-content" aria-selected="true"
                                        onclick="selectInputType('video')">
                                    <i class="fas fa-film me-2"></i> Video
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="csv-tab" data-bs-toggle="tab" data-bs-target="#csv-content" 
                                        type="button" role="tab" aria-controls="csv-content" aria-selected="false"
                                        onclick="selectInputType('csv')">
                                    <i class="fas fa-file-csv me-2"></i> CSV Upload
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="url-tab" data-bs-toggle="tab" data-bs-target="#url-content" 
                                        type="button" role="tab" aria-controls="url-content" aria-selected="false"
                                        onclick="selectInputType('url')">
                                    <i class="fab fa-github me-2"></i> GitHub URL
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Hidden radio buttons for form submission -->
                        <div style="display: none;">
                            {{ form.input_type(id="input_type_video", value="video") }}
                            {{ form.input_type(id="input_type_csv", value="csv") }}
                            {{ form.input_type(id="input_type_url", value="url") }}
                            <input type="hidden" id="selected_input_type" name="selected_input_type" value="video">
                        </div>
                        
                        <!-- Tab content -->
                        <div class="tab-content" id="inputTypeContent">
                            <!-- Video Tab -->
                            <div class="tab-pane fade show active" id="video-content" role="tabpanel" aria-labelledby="video-tab">
                                <div class="card border-0 mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title">Upload Video File</h5>
                                        <p class="text-muted mb-3">
                                            Upload a video file to be transcribed and analyzed. Supports MP4, AVI, MOV, and MKV formats.
                                        </p>
                                        
                                        <div class="mb-3">
                                            <div class="input-group">
                                                {{ form.video_file(class="form-control" + (" is-invalid" if form.video_file.errors else ""), style="display: none;", onchange="updateFileLabel(this)") }}
                                                <label class="input-group-text btn btn-outline-secondary" for="{{ form.video_file.id }}">
                                                    <i class="fas fa-upload me-2"></i> Choose File
                                                </label>
                                                <span class="form-control video-file-label">No file selected</span>
                                            </div>
                                            {% if form.video_file.errors %}
                                                <div class="text-danger mt-2">
                                                    {% for error in form.video_file.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            The video will be transcribed and relationships will be extracted from the transcription.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CSV Tab -->
                            <div class="tab-pane fade" id="csv-content" role="tabpanel" aria-labelledby="csv-tab">
                                <div class="card border-0 mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title">Upload CSV File</h5>
                                        <p class="text-muted mb-3">
                                            Upload a CSV file containing structured data for relationship extraction.
                                        </p>
                                        
                                        <div class="mb-3">
                                            <div class="input-group">
                                                {{ form.csv_file(class="form-control" + (" is-invalid" if form.csv_file.errors else ""), style="display: none;", onchange="updateFileLabel(this)") }}
                                                <label class="input-group-text btn btn-outline-secondary" for="{{ form.csv_file.id }}">
                                                    <i class="fas fa-upload me-2"></i> Choose File
                                                </label>
                                                <span class="form-control csv-file-label">No file selected</span>
                                            </div>
                                            {% if form.csv_file.errors %}
                                                <div class="text-danger mt-2">
                                                    {% for error in form.csv_file.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Your CSV should contain structured data with column headers.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- URL Tab -->
                            <div class="tab-pane fade" id="url-content" role="tabpanel" aria-labelledby="url-tab">
                                <div class="card border-0 mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title">GitHub Raw CSV URL</h5>
                                        <p class="text-muted mb-3">
                                            Provide a raw GitHub URL to a CSV file for analysis.
                                        </p>
                                        
                                        <div class="mb-3">
                                            <label for="{{ form.github_url.id }}" class="form-label">URL</label>
                                            {{ form.github_url(class="form-control" + (" is-invalid" if form.github_url.errors else ""), placeholder="https://raw.githubusercontent.com/username/repo/main/data.csv") }}
                                            {% if form.github_url.errors %}
                                                <div class="text-danger mt-2">
                                                    {% for error in form.github_url.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Use the "Raw" URL of a CSV file from GitHub.<br>
                                            Example: <code>https://raw.githubusercontent.com/username/repo/main/data.csv</code>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Processing Information Box -->
                        <div class="card bg-dark mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Processing Information</h5>
                                <p class="card-text">
                                    <i class="fas fa-info-circle me-2 text-info"></i>
                                    Data will be processed to extract entities and relationships based on the "{{ graph.domain }}" domain.
                                </p>
                                <ul class="list-group list-group-flush bg-dark">
                                    <li class="list-group-item bg-dark">
                                        <i class="fas fa-check-circle me-2 text-success"></i>
                                        The extracted relationships will be added to your knowledge graph.
                                    </li>
                                    <li class="list-group-item bg-dark">
                                        <i class="fas fa-check-circle me-2 text-success"></i>
                                        You can visualize and query the graph after processing is complete.
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to update file label when file is selected
    function updateFileLabel(input) {
        if (input.files && input.files[0]) {
            const fileType = input.id === '{{ form.video_file.id }}' ? 'video' : 'csv';
            const label = document.querySelector(`.${fileType}-file-label`);
            if (label) {
                label.textContent = input.files[0].name;
            }
        }
    }
    
    // Function to select the right input type radio button
    function selectInputType(type) {
        // Check the appropriate radio button (hidden)
        const radioButton = document.getElementById(`input_type_${type}`);
        if (radioButton) {
            radioButton.checked = true;
            
            // Set the selected_input_type hidden field
            document.getElementById('selected_input_type').value = type;
            
            console.log("Selected input type changed to:", type);
        }
    }
    
    // Initialize the first tab on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners to tab buttons
        document.getElementById('video-tab').addEventListener('click', function() {
            selectInputType('video');
        });
        
        document.getElementById('csv-tab').addEventListener('click', function() {
            selectInputType('csv');
        });
        
        document.getElementById('url-tab').addEventListener('click', function() {
            selectInputType('url');
        });
        
        // Set initial selection
        selectInputType('video');
        
        // Before form submission, ensure the correct input type is set
        document.querySelector('form').addEventListener('submit', function(e) {
            // Get the active tab
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                if (activeTab.id === 'video-tab') selectInputType('video');
                else if (activeTab.id === 'csv-tab') selectInputType('csv');
                else if (activeTab.id === 'url-tab') selectInputType('url');
            }
            
            console.log("Form submitting with input type:", document.getElementById('selected_input_type').value);
        });
    });
</script>
{% endblock %}
