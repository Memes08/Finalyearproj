{% extends "base.html" %}

{% block title %}Process Data - Knowledge Graph Builder{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}" class="text-decoration-none">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Process Data</li>
                </ol>
            </nav>
            
            <!-- Page Header -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h2 class="mb-0">Add Data to Graph</h2>
                <span class="badge bg-info fs-5 px-3 py-2">{{ graph.name }} ({{ graph.domain }})</span>
            </div>
            
            <!-- Main Content Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('process_data', graph_id=graph.id) }}" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        
                        <!-- Source Selection Pills -->
                        <div class="mb-5">
                            <h5 class="mb-3 text-secondary">1. Select Data Source</h5>
                            
                            <ul class="nav nav-pills nav-justified gap-2" id="inputTypeTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active w-100 py-3" id="video-tab" data-bs-toggle="pill" 
                                            data-bs-target="#video-content" type="button" role="tab" 
                                            aria-controls="video-content" aria-selected="true"
                                            onclick="selectInputType('video')">
                                        <i class="fas fa-film me-2"></i> Video File
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link w-100 py-3" id="csv-tab" data-bs-toggle="pill" 
                                            data-bs-target="#csv-content" type="button" role="tab" 
                                            aria-controls="csv-content" aria-selected="false"
                                            onclick="selectInputType('csv')">
                                        <i class="fas fa-file-csv me-2"></i> CSV Upload
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link w-100 py-3" id="url-tab" data-bs-toggle="pill" 
                                            data-bs-target="#url-content" type="button" role="tab" 
                                            aria-controls="url-content" aria-selected="false"
                                            onclick="selectInputType('url')">
                                        <i class="fab fa-github me-2"></i> GitHub URL
                                    </button>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Hidden radio buttons for form submission -->
                        <div style="display: none;">
                            {{ form.input_type(id="input_type_video", value="video") }}
                            {{ form.input_type(id="input_type_csv", value="csv") }}
                            {{ form.input_type(id="input_type_url", value="url") }}
                            <input type="hidden" id="selected_input_type" name="selected_input_type" value="video">
                        </div>
                        
                        <!-- Source Content Section -->
                        <div class="mb-5">
                            <h5 class="mb-3 text-secondary">2. Provide Input Data</h5>
                            
                            <div class="tab-content p-4 border rounded bg-light" id="inputTypeContent">
                                <!-- Video Tab -->
                                <div class="tab-pane fade show active" id="video-content" role="tabpanel" aria-labelledby="video-tab">
                                    <div class="text-center">
                                        <div class="mb-4">
                                            <i class="fas fa-film fa-3x text-primary mb-3"></i>
                                            <h5 class="fw-bold">Upload Video File</h5>
                                            <p class="text-muted">
                                                Upload a video to be transcribed and analyzed.<br>
                                                Supports MP4, AVI, MOV, and MKV formats.
                                            </p>
                                        </div>
                                        
                                        <div class="mb-3 w-75 mx-auto">
                                            <div class="input-group">
                                                {{ form.video_file(class="form-control" + (" is-invalid" if form.video_file.errors else ""), style="display: none;", onchange="updateFileLabel(this)") }}
                                                <label class="input-group-text btn btn-primary" for="{{ form.video_file.id }}">
                                                    <i class="fas fa-upload me-2"></i> Select File
                                                </label>
                                                <span class="form-control video-file-label">No file selected</span>
                                            </div>
                                            {% if form.video_file.errors %}
                                                <div class="text-danger mt-2">
                                                    {% for error in form.video_file.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- CSV Tab -->
                                <div class="tab-pane fade" id="csv-content" role="tabpanel" aria-labelledby="csv-tab">
                                    <div class="text-center">
                                        <div class="mb-4">
                                            <i class="fas fa-file-csv fa-3x text-success mb-3"></i>
                                            <h5 class="fw-bold">Upload CSV File</h5>
                                            <p class="text-muted">
                                                Upload a CSV file containing structured data.<br>
                                                Your file should have proper headers and entity relationships.
                                            </p>
                                        </div>
                                        
                                        <div class="mb-3 w-75 mx-auto">
                                            <div class="input-group">
                                                {{ form.csv_file(class="form-control" + (" is-invalid" if form.csv_file.errors else ""), style="display: none;", onchange="updateFileLabel(this)") }}
                                                <label class="input-group-text btn btn-success" for="{{ form.csv_file.id }}">
                                                    <i class="fas fa-upload me-2"></i> Select File
                                                </label>
                                                <span class="form-control csv-file-label">No file selected</span>
                                            </div>
                                            {% if form.csv_file.errors %}
                                                <div class="text-danger mt-2">
                                                    {% for error in form.csv_file.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- URL Tab -->
                                <div class="tab-pane fade" id="url-content" role="tabpanel" aria-labelledby="url-tab">
                                    <div class="text-center">
                                        <div class="mb-4">
                                            <i class="fab fa-github fa-3x text-info mb-3"></i>
                                            <h5 class="fw-bold">GitHub Raw CSV URL</h5>
                                            <p class="text-muted">
                                                Provide a raw GitHub URL to a CSV file for analysis.<br>
                                                Example format: https://raw.githubusercontent.com/username/repo/main/data.csv
                                            </p>
                                        </div>
                                        
                                        <div class="w-75 mx-auto">
                                            {{ form.github_url(class="form-control form-control-lg" + (" is-invalid" if form.github_url.errors else ""), 
                                                placeholder="https://raw.githubusercontent.com/username/repo/main/data.csv") }}
                                            {% if form.github_url.errors %}
                                                <div class="text-danger mt-2">
                                                    {% for error in form.github_url.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Processing Information -->
                        <div class="mb-5">
                            <h5 class="mb-3 text-secondary">3. Review Processing Details</h5>
                            
                            <div class="p-4 border rounded bg-dark text-light">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="me-3">
                                        <i class="fas fa-project-diagram fa-2x text-info"></i>
                                    </div>
                                    <div>
                                        <h5 class="fw-bold mb-1">Knowledge Graph Processing</h5>
                                        <p class="mb-0">
                                            Data will be analyzed to extract entities and relationships for the "{{ graph.domain }}" domain.
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="d-flex ps-5 mb-2">
                                    <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                    <div>The extracted relationships will be added to your knowledge graph.</div>
                                </div>
                                
                                <div class="d-flex ps-5">
                                    <i class="fas fa-check-circle text-success me-2 mt-1"></i>
                                    <div>You can visualize and query the graph after processing is complete.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Indicator (hidden by default) -->
                        <div id="progressContainer" class="mb-5 d-none">
                            <h5 class="mb-3 text-secondary">Processing Progress</h5>
                            
                            <div class="p-4 border rounded bg-light">
                                <!-- Progress bar with color coding based on status -->
                                <div class="progress mb-3" style="height: 25px;">
                                    <div id="progressBar" 
                                         class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         aria-valuenow="0" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100" 
                                         style="width: 0%"></div>
                                </div>
                                
                                <!-- Status text -->
                                <div class="d-flex align-items-center">
                                    <div id="progressSpinner" class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div id="progressStatus" class="fw-bold">Initializing...</div>
                                </div>
                                
                                <!-- Step indicators -->
                                <div class="mt-4">
                                    <div class="row">
                                        <div class="col-md-3 mb-2">
                                            <div id="step-init" class="step-indicator d-flex align-items-center">
                                                <div class="step-bullet bg-secondary rounded-circle d-flex justify-content-center align-items-center me-2" style="width: 24px; height: 24px;">
                                                    <i class="fas fa-circle text-white small"></i>
                                                </div>
                                                <div class="step-label">Initialize</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <div id="step-upload" class="step-indicator d-flex align-items-center">
                                                <div class="step-bullet bg-secondary rounded-circle d-flex justify-content-center align-items-center me-2" style="width: 24px; height: 24px;">
                                                    <i class="fas fa-circle text-white small"></i>
                                                </div>
                                                <div class="step-label">Upload</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <div id="step-extraction" class="step-indicator d-flex align-items-center">
                                                <div class="step-bullet bg-secondary rounded-circle d-flex justify-content-center align-items-center me-2" style="width: 24px; height: 24px;">
                                                    <i class="fas fa-circle text-white small"></i>
                                                </div>
                                                <div class="step-label">Extract</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <div id="step-database" class="step-indicator d-flex align-items-center">
                                                <div class="step-bullet bg-secondary rounded-circle d-flex justify-content-center align-items-center me-2" style="width: 24px; height: 24px;">
                                                    <i class="fas fa-circle text-white small"></i>
                                                </div>
                                                <div class="step-label">Save</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary btn-lg py-3") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to update file label when file is selected
    function updateFileLabel(input) {
        if (input.files && input.files[0]) {
            const fileType = input.id === '{{ form.video_file.id }}' ? 'video' : 'csv';
            const label = document.querySelector(`.${fileType}-file-label`);
            if (label) {
                label.textContent = input.files[0].name;
            }
        }
    }
    
    // Function to select the right input type radio button
    function selectInputType(type) {
        // Check the appropriate radio button (hidden)
        const radioButton = document.getElementById(`input_type_${type}`);
        if (radioButton) {
            radioButton.checked = true;
            
            // Set the selected_input_type hidden field
            document.getElementById('selected_input_type').value = type;
            
            console.log("Selected input type changed to:", type);
        }
    }
    
    // Progress tracking functionality
    let progressInterval;
    let processId = '';
    
    // Function to start progress monitoring
    function startProgressMonitoring(id) {
        processId = id;
        
        // Show progress container
        document.getElementById('progressContainer').classList.remove('d-none');
        
        // Hide submit button and form inputs
        document.querySelector('.d-grid').classList.add('d-none');
        Array.from(document.querySelectorAll('.tab-pane')).forEach(pane => {
            pane.classList.add('disabled');
        });
        Array.from(document.querySelectorAll('.nav-link')).forEach(tab => {
            tab.classList.add('disabled');
            tab.setAttribute('disabled', 'disabled');
        });
        
        // Set initial progress
        updateProgress({
            status: 'Starting processing...',
            percent: 5,
            step: 'init'
        });
        
        // Start polling for progress
        progressInterval = setInterval(fetchProgress, 1000);
    }
    
    // Function to fetch progress from the server
    function fetchProgress() {
        fetch(`/api/progress/${processId}`)
            .then(response => response.json())
            .then(data => {
                updateProgress(data);
                
                // If processing is complete or errored, stop polling
                if (data.percent >= 100 || data.step === 'complete' || data.step === 'error') {
                    clearInterval(progressInterval);
                    
                    if (data.step === 'complete') {
                        // Show success message and redirect in 3 seconds
                        setTimeout(() => {
                            console.log('Processing complete, redirecting...');
                            // The redirect will be handled by the server, just stop polling
                        }, 3000);
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching progress:', error);
            });
    }
    
    // Function to update the progress UI
    function updateProgress(data) {
        // Update progress bar
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = `${data.percent}%`;
        progressBar.setAttribute('aria-valuenow', data.percent);
        
        // Update status text
        document.getElementById('progressStatus').textContent = data.status;
        
        // Update progress bar color based on step
        if (data.step === 'error') {
            progressBar.classList.remove('bg-info', 'bg-success', 'bg-warning', 'bg-primary');
            progressBar.classList.add('bg-danger');
            document.getElementById('progressSpinner').classList.add('d-none');
        } else if (data.percent >= 100) {
            progressBar.classList.remove('bg-info', 'bg-danger', 'bg-warning', 'bg-primary');
            progressBar.classList.add('bg-success');
        } else if (data.step === 'upload' || data.step === 'transcription') {
            progressBar.classList.remove('bg-success', 'bg-danger', 'bg-primary');
            progressBar.classList.add('bg-info');
        } else if (data.step === 'extraction' || data.step === 'analysis') {
            progressBar.classList.remove('bg-success', 'bg-danger', 'bg-info');
            progressBar.classList.add('bg-primary');
        } else if (data.step === 'database' || data.step === 'finalizing') {
            progressBar.classList.remove('bg-success', 'bg-danger', 'bg-info', 'bg-primary');
            progressBar.classList.add('bg-warning');
        }
        
        // Update step indicators
        const steps = {
            'waiting': [],
            'init': ['init'],
            'upload': ['init', 'upload'],
            'analysis': ['init', 'upload'],
            'transcription': ['init', 'upload'],
            'extraction': ['init', 'upload', 'extraction'],
            'fallback': ['init', 'upload', 'extraction'],
            'database': ['init', 'upload', 'extraction', 'database'],
            'finalizing': ['init', 'upload', 'extraction', 'database'],
            'complete': ['init', 'upload', 'extraction', 'database']
        };
        
        // Reset all steps
        document.querySelectorAll('.step-indicator .step-bullet').forEach(bullet => {
            bullet.classList.remove('bg-success', 'bg-primary', 'bg-danger');
            bullet.classList.add('bg-secondary');
        });
        
        // Highlight completed steps
        const completedSteps = steps[data.step] || [];
        completedSteps.forEach(step => {
            const stepElement = document.getElementById(`step-${step}`);
            if (stepElement) {
                const bullet = stepElement.querySelector('.step-bullet');
                bullet.classList.remove('bg-secondary');
                
                if (data.step === 'error') {
                    bullet.classList.add('bg-danger');
                } else {
                    bullet.classList.add('bg-success');
                }
            }
        });
        
        // Highlight current step if not complete or error
        if (data.step !== 'complete' && data.step !== 'error' && data.step !== 'waiting') {
            const currentStep = document.getElementById(`step-${data.step}`);
            if (currentStep) {
                const bullet = currentStep.querySelector('.step-bullet');
                bullet.classList.remove('bg-secondary', 'bg-success');
                bullet.classList.add('bg-primary');
            }
        }
    }
    
    // Initialize the form on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners to tab buttons
        document.getElementById('video-tab').addEventListener('click', function() {
            selectInputType('video');
        });
        
        document.getElementById('csv-tab').addEventListener('click', function() {
            selectInputType('csv');
        });
        
        document.getElementById('url-tab').addEventListener('click', function() {
            selectInputType('url');
        });
        
        // Set initial selection
        selectInputType('video');
        
        // Before form submission, ensure the correct input type is set and start progress monitoring
        document.querySelector('form').addEventListener('submit', function(e) {
            // Get the active tab
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                if (activeTab.id === 'video-tab') selectInputType('video');
                else if (activeTab.id === 'csv-tab') selectInputType('csv');
                else if (activeTab.id === 'url-tab') selectInputType('url');
            }
            
            console.log("Form submitting with input type:", document.getElementById('selected_input_type').value);
            
            // Use the current process ID from the session if available, otherwise generate a temporary one
            const processId = '{{ current_process_id }}' || '{{ graph.id }}_' + Math.random().toString(36).substring(2, 15);
            
            // Start progress monitoring after a short delay (to allow form submission)
            setTimeout(() => {
                startProgressMonitoring(processId);
            }, 500);
        });
    });
</script>
{% endblock %}
